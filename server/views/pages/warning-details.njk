{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - " + breachNotice.breachNoticeTypeDescription + " Details" %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

  {% from "moj/components/side-navigation/macro.njk" import mojSideNavigation %}
  {% from "govuk/components/radios/macro.njk" import govukRadios %}
  {% from "govuk/components/select/macro.njk" import govukSelect %}
  {% from "govuk/components/button/macro.njk" import govukButton %}
  {% from "moj/components/date-picker/macro.njk" import mojDatePicker %}
  {% from "govuk/components/table/macro.njk" import govukTable %}
  {% from "govuk/components/input/macro.njk" import govukInput %}
  {% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
  {% from "govuk/components/details/macro.njk" import govukDetails %}
  {% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}

  <form method="post">
    {% set errorList =[
      { text: errorMessages.responseRequiredByDate.text, href: "#responseRequiredByDate" } if errorMessages.responseRequiredByDate else None,
      { text: errorMessages.furtherReasonDetails.text, href: "#furtherReasonDetails" } if errorMessages.furtherReasonDetails else None,
      { text: errorMessages.genericErrorMessage.text, href: "#" } if errorMessages.genericErrorMessage else None
    ] | reject("undefined") %}
    {% if errorMessages | length > 0 %}
      {% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
      {{ govukErrorSummary({ titleText: "There is a problem", errorList: errorList }) }}
    {% endif %}
    <input type="hidden" name="_csrf" value="{{ csrfToken }}">

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        {% set alternateAddressHtml %}
          HELLO HELLO
{#          {{ govukSelect({#}
{#            id: "alternate-address",#}
{#            name: "alternateAddress",#}
{#            label: {#}
{#              text: "Please pick an alternative postal address",#}
{#              classes: "govuk-fieldset__legend--m"#}
{#            },#}
{#            items: alternateAddressOptions#}
{#          }) }}#}
        {% endset -%}




        {% include "pages/side-nav.njk" %}
      </div>
      <div class="govuk-grid-column-two-thirds">
        {% if not showEmbeddedError %}
        {% include "partials/review-required.njk" %}
        <h1
          class="govuk-heading-l">{{ "Warning Details" + " - " + breachNotice.breachNoticeTypeDescription }}</h1>
        <h2 class="govuk-heading-m">
          Condition being enforced
        </h2>
        <p id="condition-being-enforced"> {{ breachNotice.conditionBeingEnforced }}</p>

        <h2 class="govuk-heading-m">
          Select the failures required on this order
        </h2>

          HERE2 - works if here





          {% if warningDetails.enforceableContacts | length > 0 %}
            <div class="govuk-form-group">
              <fieldset class="govuk-fieldset">
                <p>Works here too</p>















                <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                  {% for failure in warningDetails.enforceableContacts %}
                    <div class="govuk-checkboxes__item">

                      <input class="govuk-checkboxes__input"
                             id="contact-{{ failure.id }}"
                             name="contact" {% if failure.id in existingContacts %}checked="checked"{% endif %}
                             type="checkbox"
                             value="{{ failure.id }}" data-aria-controls="conditional-{{ failure.id }}">
                      <label class="govuk-label govuk-checkboxes__label" for="contact-{{ failure.id }}">
                        {% set failureHtml = failure.notes | escape | nl2br | safe %}
                        {{ failure.datetime | toUserDate }}, {{ failure.type.description }}, {{ failure.outcome.description }}
                      </label>



                    </div>





                    <div class="govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden"
                         id="conditional-{{ failure.id }}">









                      <div class="govuk-form-group">

                        {% set optionalRegistrationsHtml %}
                          {{ govukDetails({
                            summaryText: "View failure notes 2",
                            html: failureHtml
                          }) }}

                          <label class="govuk-heading-m">
                            Requirements
                          </label>
                        {% set matchFound = false %}
                        {% set buttonText = 'Save Changes and Add Requirement' %}
                        {% set requirement = null %}

                          {% for cr in contactRequirementList %}
                            {% if cr.contact.contactId == failure.id %}
                              {% set matchFound = true %}
                              {% set buttonText = 'Save Changes and Update Requirement' %}
                              <p class="govuk-body govuk-!-margin-bottom-1">{{ cr.requirement.requirementTypeMainCategoryDescription }}, {{ cr.requirement.rejectionReason }} </p>
                            {% endif %}
                          {% endfor %}
                          {% if not matchFound %}
                            <p>No requirements have been selected, in order to complete this form please use the below
                              to add requirement</p>
                          {% endif %}
                          {{ govukButton({
                            text: buttonText ,
                            preventDoubleClick: "true",
                            type: "submit",
                            name: "action",
                            value: "enforceablecontact_"+failure.id,
                            classes: "govuk-button--primary",
                            attributes: {
                              id: "updatereq-button"
                            }
                          }) }}
                        {% endset -%}



                        {% set wholeTermSelect %}
                          {{ govukSelect({
                            id: "failureReasonWholeTermContact_"+failure.id,
                            name: "failureReasonWholeTermContact_"+failure.id,
                            label: {
                              text: "Please select a failure reason"
                            },
                            items: [
                              {
                                value: "published",
                                text: "Recently published"
                              },
                              {
                                value: "updated",
                                text: "Recently updated",
                                selected: true
                              },
                              {
                                value: "views",
                                text: "Most views"
                              },
                              {
                                value: "comments",
                                text: "Most comments"
                              }
                            ]
                          }) }}
                        {% endset -%}



                        {{ govukRadios({
                          name: "wholeSentence-"+failure.id,
                          fieldset: {
                            legend: {
                              text: "Does this apply to the whole sentence?",
                              isPageHeading: false,
                              classes: "govuk-fieldset__legend--m"
                            }
                          },
                          hint: {
                            text: "Select one option"
                          },
                          items: [
                            {
                              value: "Yes",
                              text: "Yes",
                              checked: failure.wholeSentence,
                              conditional: {
                              html: wholeTermSelect
                            }
                            },
                            {
                              value: "No",
                              text: "No",
                              checked: failure.wholeSentence === false,
                              conditional: {
                              html: optionalRegistrationsHtml
                            }
                            }
                          ]
                        }) }}








                      </div>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
            </div>
          {% else %}
          <p id="no-enforceable-contacts-message">No failures to display.</p>
          <p id="no-enforceable-contacts-supplimentary-message">This notice cannot be completed without evidence of the failure that has prompted its creation.</p>
          <p id="contact-deeplink-message">
            <a href="{{ contactListDeeplink }}" target="_blank" id="contactListDeeplink">
              click this hyperlink to open Delius in a new tab and check
            </a>
          </p>
        {% endif %}

        {{ govukCharacterCount({
          label: {
            text: "Further reason details",
            classes: "govuk-label--m",
            isPageHeading: false
          },
          id: "furtherReasonDetails",
          value: furtherReasonDetails,
          classes: "govuk-input--width-30",
          name: "furtherReasonDetails",
          maxlength: 4000,
          errorMessage: {
            text: errorMessages.furtherReasonDetails.text
          } if errorMessages.furtherReasonDetails.text
        }) }}

        {{ mojDatePicker({
          id: "responseRequiredByDate",
          name: "responseRequiredByDate",
          value: warningDetailsResponseRequiredDate,
          label: {
            text: "Response Required By",
            classes: "govuk-fieldset__legend--m"
          },
          hint: {
            text: "For example, 17/5/2024."
          },
          errorMessage: {
            text: errorMessages.responseRequiredByDate.text
          } if errorMessages.responseRequiredByDate.text
        }) }}

        <div class="moj-button-group">
          {{ govukButton({
            text: "Continue",
            preventDoubleClick: "true",
            type: "submit",
            attributes: {
              id: "continue-button"
            }
          }) }}

          {{ govukButton({
            text: "Refresh from Delius",
            preventDoubleClick: "true",
            type: "submit",
            name: "action",
            value: "refreshFromNdelius",
            classes: "govuk-button--secondary",
            attributes: {
              id: "refresh-from-ndelius--button"
            }
          }) }}

          {{ govukButton({
            text: "Save Progress and Close",
            preventDoubleClick: "true",
            type: "submit",
            name: "action",
            value: "saveProgressAndClose",
            classes: "govuk-button--secondary",
            attributes: {
              id: "close-button"
            }
          }) }}
        </div>
        {% endif %}
      </div>
    </div>
  </form>

{% endblock %}
